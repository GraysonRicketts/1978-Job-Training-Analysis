---
title: "Propensity Score Implementation"
author: "Grayson Ricketts"
date: "11/7/2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = 'pdf', fig.path = 'Figs/',
                      fig.width = 8.5, fig.height = 5,
                      echo = TRUE, warnings = FALSE)

library(ggplot2)
theme_set(theme_minimal())
```

```{r, echo=FALSE}
df <- read.table("job_training_observational_data.txt", header = TRUE)

# Removes the response variable so that the design is not biased by outcomes
df <- within(df, rm("RE78"))

# Removes redundant variable already represented by TREAT
df <- within(df, rm("TYPE"))
```

# Logistic Regression of Propensity Scores

## Standard Model
```{r}
df <- within(df, rm("TYPE"))
model <- glm(TREAT ~ ., data = df, family=binomial(link = "logit"))
summary(model)
```

## Reduced Model
```{r}
bad.factors <- c("NODEGREE", "EDUC", "RE74")
df.reduced <- df[ , !(names(df) %in% bad.factors)]

model.reduced <- glm(TREAT ~ ., data = df.reduced, family=binomial(link = "logit"))
summary(model.reduced)
summary(model)
```

## Model Checking

### Half-Normal Plot of Residuals
```{r}
library(faraway)
halfnorm(residuals(model))
halfnorm(residuals(model.reduced))
```

### Chi-Squared Goodness-of-Fit-Test with ANOVA
```{r}
anova(model, test = "Chisq")
anova(model.reduced, test = "Chisq")
```

### Chi-Squared Goodness-of-Fit-Test for Model
```{r}
sum(residuals(model, type = "pearson")^2)
deviance(model)
pchisq(deviance(model), df.residual(model))
pchisq(deviance(model.reduced), df.residual(model.reduced))
```

### Hosmer-Lemeshow test
```{r}
hosmerlem <- function (y, yhat, g = 10) {
   cutyhat <- cut(yhat, breaks = quantile(yhat, probs = seq(0, 1, 1/g)),
                  include.lowest = TRUE)
   obs <- xtabs(cbind(1 - y, y) ~ cutyhat)
   expect <- xtabs(cbind(1 - yhat, yhat) ~ cutyhat)
   chisq <- sum((obs - expect)^2 / expect)
   P <- 1 - pchisq(chisq, g - 2)
   c("X^2" = chisq, Df = g - 2, "P(>Chi)" = P)
}
hosmerlem(y = df$TREAT, yhat = fitted(model))
hosmerlem(y = df$TREAT, yhat = fitted(model.reduced))
```

## Summary of Model Checking
It appears that both models are accurate in their prediction. This can be seen in the low Chi-Squared probabilities of the standard Chi-Squared Goodness-of-Fit-Test and the Hosmer-Lemeshow test.

